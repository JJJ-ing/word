# 商城项目总结

## 1 商城系统架构

![wps1](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\wps1.jpg)

### 1.1 前后台系统主要功能

整个商城可以分为两部分：后台管理系统、前台门户系统

#### 1.1.1 后台管理

后台系统主要包含以下功能：

​	1、商品管理，包括商品分类、品牌、商品规格等信息的管理

​	2、销售管理，包括订单统计、订单退款处理、促销活动生成等

​	3、用户管理，包括用户控制、冻结、解锁等

​	4、权限管理，整个网站的权限控制，采用JWT鉴权方案，对用户及API进行权限控制

​	5、统计，各种数据的统计分析展示

#### 1.1.2 前台门户

前台门户面向的是客户，包含与客户交互的一切功能。例如:

​	1、搜索商品

​	2、加入购物车

​	3、下单

​	4、评价商品等等

无论是前台还是后台系统，都共享相同的微服务集群，包括：

​	1、商品微服务：商品及商品分类、品牌、库存等的服务

​	2、搜索微服务：实现搜索功能

​	3、订单微服务：实现订单相关

​	4、购物车微服务：实现购物车相关功能

​	5、用户中心：用户的登录注册等功能

​	6、Eureka注册中心

​	7、Zuul网关服务

​	8、Spring Cloud Config配置中心

​	9、...

预览图：

![image-20201230170648840](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20201230170648840.png)

#### 1.1.3 项目结构

mingrui-shop-parent

​	mingrui-shop-basics

​		mingrui-shop-basics-upload-server	[8200]

​		mingrui-shop-basics-eureka-server	[8761]

​		mingrui-shop-basics-zuul-server	[8088 --> 80]

​	mingrui-shop-commons

​		mingrui-shop-common-core

​	mingrui-shop-services

​		mingrui-shop-service-categoty	[8100]

​	mingrui-shop--services-api

​		mingrui-shop--services-api-categoty

![image-20201230171028876](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20201230171028876.png)

## 2 项目搭建

### 2.1 技术选型

#### 2.1.1 前端技术：

1、基础的HTML、CSS、JavaScript（基于ES6标准）

2、JQuery

3、Vue.js 2.0以及基于Vue的UI框架：Vuetify

4、前端构建工具：WebPack

5、前端安装包工具：NPM

6、Vue脚手架：Vue-cli

7、Vue路由：vue-router

8、ajax框架：axios

9、基于Vue的富文本框架：quill-editor

#### 2.1.2 后端技术：

1、基础的SpringMVC、Spring 5.0和MyBatis3

2、Spring Boot 2.2.2版本

3、Spring Cloud 版本 Hoxton.SR1

4、Redis-4.0

5、RabbitMQ-3.8

6、Elasticsearch-5.6.8

7、nginx-1.10.2

8、FastDFS - 5.0.8

9、MyCat

10、Thymeleaf

11、JWT

### 2.2 创建项目

#### 2.2.1 创建父工程

![image-20201230173437529](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20201230173437529.png)

E:\14602\idea-projects\baidu-shop\mingrui-shop-parent

注意包结构，父工程放在单独文档，且父工程不需要写任何代码

##### 2.2.1.1 pom.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-parent</artifactId>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>mingrui-shop-basics</module>
        <module>mingrui-shop-commoms</module>
        <module>mingrui-shop-service</module>
        <module>mingrui-shop-service-api</module>
    </modules>

    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <properties>
        <!--项目构建编码-->
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
        <!--声明JDK版本-->
        <java.version>1.8</java.version>
        <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
        <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
    </properties>
    <!--boot 版本-->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <!--始终从仓库中获取，不从本地路径获取-->
        <relativePath />
    </parent>
    <dependencies>
        <!-- 集成commons工具类 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        <!-- 集成lombok 框架 -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!--junit测试-->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- SpringBoot整合eureka客户端 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--boot 测试模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    <!-- 项目依赖,子级模块可以继承依赖-->
    <dependencyManagement>
    <dependencies>
    <!--cloud 依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${mr.spring.cloud.version}</version>
            <type>pom</type>
            <!--解决maven单继承的问题-->
            <scope>import</scope>
        </dependency>
    </dependencies>
    </dependencyManagement>
    <!-- 注意： 这里必须要添加， 否则各种依赖有问题 -->
    <repositories>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/libs-milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>

</project>
```

#### 2.2.2 创建公共工具

1. 在mingrui-shop-parent 工程名上右键-->new-->module 

2. 项目名为: mingrui-shop-commoms

   注意包结构，父工程放在单独文档，且父工程不需要写任何代码！！！

##### 2.2.2.1 pom.xml

```
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
<modules>
	<module>mingrui-shopcommon-core</module>
</modules>
```

#### 2.2.3 创建服务实现

1. 在mingrui-shop-parent 工程名上右键-->new-->module 

2. 项目名为: mingrui-shop-service

   注意包结构，父工程放在单独文档，且父工程不需要写任何代码！！！

##### 2.2.3.1 pom.xml

```
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>

<dependencies>

    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- springcloud feign组件 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>

</dependencies>
```

#### 2.2.4 创建服务接口

1. 在mingrui-shop-parent 工程名上右键-->new-->module 

2. 项目名为: mingrui-shop-service-api

   注意包结构，父工程放在单独文档，且父工程不需要写任何代码！！！

##### 2.2.4.1 pom.xml

```
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>

<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

#### 2.2.5 创建eureka服务

在mingrui-shop-basics工程名上右键-->new-->module

![image-20210105133740230](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105133740230.png)

注意:在点击finish之前一定要确认一遍当前创建工程的父工程是mingrui-shop-basics,接下来的项目创 建的时候也是一样的..

##### 2.2.5.1 pom.xml

```
<dependencies>
    <!--eureka 服务依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

##### 2.2.5.2 application.yml

```
server:
  port: 8761
spring:
  application:
    name: eureka-server
eureka:
  client:
    # eureka服务url,值为map集合默认key为defaultZone
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    # 当前服务是否同时注册
    register-with-eureka: false
    # 去注册中心获取其他服务的地址
    fetch-registry: false
  instance:
    hostname: localhost
    # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
    lease-renewal-interval-in-seconds: 1
    # 定义服务失效的时间，单位：秒 默认90
    lease-expiration-duration-in-seconds: 2
  server:
    # 测试时关闭自我保护机制，保证不可用服务及时踢出
    enable-self-preservation: false

```

##### 2.2.5.3 启动类

src/main/java建包com.baidu.shop下创建RunEurekaServerApplication

```
package com.baidu.shop;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

/**
 * @ClassName RunEurekaServerApplication
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/22
 * @Version V1.0
 **/

@SpringBootApplication
@EnableEurekaServer
public class RunEurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunEurekaServerApplication.class);
    }
}

```

## 3 域名访问本地项目

### 3.1  统一环境

访问页面使用的是：http://localhost:9001

实际开发中，会有不同的环境： 

开发环境：自己的电脑 

测试环境：提供给测试人员使用的环境 

预发布环境：数据是和生成环境的数据一致，运行最新的项目代码进去测试 

生产环境：项目最终发布上线的环境

如果不同环境使用不同的ip去访问，可能会出现一些问题。为了保证所有环境的一致，我们会在各种环境下都使用域名来访问。

将使用以下域名： 

主域名是：www.mrshop.com， 

管理系统域名：manage.mrshop.com 

网关域名：api.mrshop.com

最终，我们希望这些域名指向的还是我们本机的某个端口。

### 3.2 域名解析

Windows下的hosts文件地址：C:/Windows/System32/drivers/etc/hosts

Linux下的hosts文件所在路径： /etc/hosts

样式：

```
# My hosts
127.0.0.1 localhost
0.0.0.0 account.jetbrains.com
127.0.0.1 www.xmind.net
```

### 3.3 解决域名问题

修改本地的 host为：

```
127.0.0.1 api.mrshop.com
127.0.0.1 manage.mrshop.com
```

添加了两个映射关系： 

127.0.0.1 api.mrshop.com ：我们的网关Zuul 

127.0.0.1 manage.shop.com：我们的后台系统地址

ping一下域名试试是否畅通：

![image-20210105142834938](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105142834938.png)

#### 3.3.1 测试

启动后端VUE项目 

解压 mrshop-manage-web.rar到vscode工作空间 

使用vscode 打开项目

![image-20210105143024902](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105143024902.png)

![image-20210105143132551](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105143132551.png)

输入域名 + 9001端口号出现上述错误 

打开build文件夹下webpack.dev.conf.js文件在devServer下加入

```
disableHostCheck: true,
```

![image-20210105143410077](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105143410077.png)

再次编译项目

### 3.4 nginx解决端口问题

我们希望的是直接域名访问： http://manage.mrshop.com 。这种情况下端口默认是80，我们需要把请求转移到9001端口用到nginx

#### 3.4.1 Nginx

![image-20210105144307971](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105144307971.png)

NIO：not-blocking-io 非阻塞IO 

BIO：blocking-IO 阻塞IO 

nginx可以作为web服务器，但更多的时候，我们把它作为网关，因为它具备网关必备的功能：

反向代理 

负载均衡 

动态路由 

请求过滤

#### 3.4.2 nginx反向代理

什么是反向代理？ 

代理：通过客户机的配置，实现让一台服务器代理客户机，客户的所有请求都交给代理服务器处 理。 

反向代理：用一台服务器，代理真实服务器，用户访问时，不再是访问真实服务器，而是代理服务 器。 

nginx可以当做反向代理服务器来使用： 

我们需要提前在nginx中配置好反向代理的规则，不同的请求，交给不同的真实服务器处理，当请求到达nginx，nginx会根据已经定义的规则进行请求的转发，从而实现路由功能

#### 3.4.3 安装和使用

##### 3.4.3.1 安装

解压nginx-1.16.1.zip 

安装完成

##### 3.4.3.2 使用

nginx可以通过命令行来启动，操作命令：

启动：

```
start nginx.exe
```

停止：

```
nginx.exe -s stop
```

重新加载：

```
nginx.exe -s reload
```

反向代理配置

修改E:\Program Files\nginx-1.16.1\conf\nginx.conf文件

```
#user nobody;
worker_processes 1;
#error_log logs/error.log;
#error_log logs/error.log notice;
#error_log logs/error.log info;
#pid logs/nginx.pid;

events {
	worker_connections 1024;
}

http {
	include mime.types;
	default_type application/octet-stream;
	
	sendfile on;
	keepalive_timeout 65;
	
	server {
		listen 80;
		server_name manage.mrshop.com;
		
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		location / {
			proxy_pass http://127.0.0.1:9001;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;
		}
}

	server {
		listen 80;
		server_name api.mrshop.com;
		
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		location / {
			proxy_pass http://127.0.0.1:8088;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;
		}
		
		location /api-xxx/upload {	
			proxy_pass http://127.0.0.1:8200;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;
			
			rewrite "^/api-xxx/(.*)$" /$1 break; 
        }
	}
	
	server {
		listen 80;
		server_name image.mrshop.com;
		
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		location ~ .*\.(gif|jpg|pdf|jpeg|png)$
		{
			#root D:/nginx-1.15.5/temp/images/;#指定图片存放路径(可以放在nginx文件夹路径里也可以放其他p盘)
			root F:\images;
		}
		
		location / {
			root html;
			index index.html index.htm;
		}
	}

}
```

##### 3.4.3.2 测试

浏览器输入http://manage.mrshop.com/

## 4 商品分类管理

### 4.1 查询

#### 4.1.1 mingrui-shop-common-core工程

##### 4.1.1.1 在mingrui-shop--commons项目下新建mingrui-shopcommon-core项目

###### 4.1.1.1.1 pom.xml

```
<dependencies>
	<!--处理json与各种数据类型或文档类型的转换-->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.5</version>
    </dependency>
    <!--json对象序列化和反序列化的支持-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--java对象和json对象之间的转换-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--alibaba的json处理工具-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.62</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.11.2</version>
    </dependency>
</dependencies>
```

##### 4.1.1.2  新建包com.baidu.shop.utils

###### 4.1.1.2.1 JSONUtil

```
package com.baidu.shop.utils;

import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/22
 * @Version V1.0
 **/

public class JSONUtil {
    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }
    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }
}

```

##### 4.1.1.3 新建包com.baidu.shop.status

###### 4.1.1.3.1 HTTPStatus

```
package com.baidu.shop.status;

/**
 * @ClassName HTTPStatus
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

public class HTTPStatus {
    //成功
    public static final int OK = 200;

    //失败
    public static final int ERROR = 500;
}

```

##### 4.1.1.4 新建包com.baidu.shop.base

###### 4.1.1.4.1 Result

泛型的高级使用 : http://note.youdao.com/noteshare?id=0268ebf433da8f8323fc549e89c89878&sub=8DEC73E9E377437A91C532288E6415627d&sub=F231BBF10BC54EBF8EF8AB87967A153D

```
package com.baidu.shop.base;

import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * @ClassName Result
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@Data
@NoArgsConstructor
public class Result<T> {
    //返回码
    private Integer code;

    //返回消息
    private String message;

    //返回数据
    private T data;

    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }
}

```

###### 4.1.1.4.2 BaseApiService

```
package com.baidu.shop.base;

import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @ClassName BaseApiService
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@Data
@Component
@Slf4j
public class BaseApiService<T> {
    public Result<T> setResultError(Integer code,String msg) {
        return setResult(code, msg, null);
    }

    //返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }

    //返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }

    //返回成功，没有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }

    //返回成功，没有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }

    protected Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , msg : %s , data : %s}",code,msg,JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }
}

```

#### 4.1.2 mingrui-shop-service-api工程

##### 4.1.2.1 pom.xml

```
<!-- SpringBoot-整合Web组件 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<!--Entity 中的@Table 和@Id需要次注解-->
<dependency>
    <groupId>javax.persistence</groupId>
    <artifactId>persistence-api</artifactId>
    <version>1.0.2</version>
</dependency>
<!--2.3版本之后web删除了验证插件-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
<!--引入common工程代码-->
<dependency>
    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shopcommon-core</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

##### 4.1.2.2 在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

###### 4.1.2.2.1 pom.xml

```
<dependencies>
    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>
    <!--提供可视化的API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
        <version>2.9.2</version>
    </dependency>
</dependencies>
```

##### 4.1.2.3 新建包com.baidu.shop.entity

###### 4.1.2.3.1 CategoryEntity

```
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * @ClassName CategoryEntity
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    @NotNull(message = "ID不能为空",groups = {MingruiOperation.Add.class})
    private Integer id;

    @ApiModelProperty(value = "分类名称")
    @NotEmpty(message = "分类名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父级分类",example = "1")
    @NotNull(message = "父类分类不能为null",groups = {MingruiOperation.Add.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    @NotNull(message = "是否为父类节点不能为null",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    @NotNull(message = "排序字段不能为null",groups = {MingruiOperation.Add.class})
    private Integer sort;
}

```

##### 4.1.2.4 swagger2的配置

###### 4.1.2.4.1 com.baidu.shop.config.MrSwagger2Config

```
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@Configuration
@EnableSwagger2
public class MrSwagger2Config {
    @Bean
    public Docket createRestApi() {
        return new Docket(DocumentationType.SWAGGER_2)
            .apiInfo(this.apiInfo())
            .select()
            .apis(RequestHandlerSelectors.basePackage("com.baidu"))
            .paths(PathSelectors.any())
            .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
            //标题
            .title("明瑞SWAGGER2标题")
            //条款地址
            .termsOfServiceUrl("http://www.baidu.com")
            //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
            .contact(new Contact("wangjing","baidu.com","JJJ_ing@163.com"))
            //版本
            .version("v1.0")
            //项目描述
            .description("描述")
            //创建API基本信息
            .build();
    }
}
```

##### 4.1.2.5 定义商品分类接口

###### 4.1.2.5.1 com.baidu.shop.

```
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;

/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/
 
@Api(tags = "商品分类接口")
public interface CategoryService {

    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
    
}
```

#### 4.1.3 mingrui-shop-service工程

##### 4.1.3.1 pom.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-parent</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>mingrui-shop-service</artifactId>

    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <modules>
        <module>mingrui-shop-service-xxx</module>
    </modules>
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.37</version>
            <scope>runtime</scope><!--项目运行阶段使用-->
        </dependency>
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shopservice-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

    </dependencies>

</project>
```

##### 4.1.3.2 在mingrui-shop-service工程下新建mingrui-shop-service-xxx工程

###### 4.1.3.2.1 application.yml

```
server:
  port: 8100

spring:
  application:
    name: xxx-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://127.0.0.1:3306/shop?nullNamePatternMatchesAll=true&serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000

# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
#日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

##### 4.1.3.3 新建包com.baidu.shop

###### 4.1.3.3.1 新建启动类

```
package com.baidu.shop;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import tk.mybatis.spring.annotation.MapperScan;

/**
 * @ClassName RunXXXApplication
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunXXXApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunXXXApplication.class);
    }
}
```

##### 4.1.3.4 在com.baidu.shop下新建包mapper

###### 4.1.3.4.1 创建mapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import tk.mybatis.mapper.common.Mapper;

public interface CategoryMapper extends Mapper<CategoryEntity> {
}
```

##### 4.1.3.5 在com.baidu.shop下新建包service.impl

###### 4.1.3.5.1 新建实现类

```
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;

/**
 * @ClassName RunXXXApplication
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/
 
@RestController
public class CategoryServiceImpl extends BaseApiService implements
CategoryService {

    @Autowired
    private CategoryMapper categoryMapper;
    
    @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
    
    CategoryEntity categoryEntity = new CategoryEntity();
    
    categoryEntity.setParentId(pid);
    
    List<CategoryEntity> list = categoryMapper.select(categoryEntity);
    
    return this.setResultSuccess(list);
    }
}

```

##### 4.1.3.6 浏览器输入

```
http://localhost:8100/category/list
```

![image-20210105194945018](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210105194945018.png)

#### 4.1.4 网关服务

##### 4.1.4.1 在mingrui-shop-basic项目下新建mingrui-shop-basic-zuul-server

###### 4.1.4.1.1 pom.xml

```
<dependencies>
    <!-- zuul -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
    </dependency>
</dependencies>
```

###### 4.1.4.1.2 application.yml

```
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server
#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

##### 4.1.4.2 新建包com.baidu

###### 4.1.4.2.1 新建启动类

```
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

/**
 * @ClassName RunZuulServerApplication
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunZuulServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunZuulServerApplication.class);
    }
}
```

##### 4.1.4.3 在com.baidu下新建global包

###### 4.1.4.3.1 新建GlobalCorsConfig

```
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;


/**
 * @ClassName GlobalCorsConfig
 * @Description: TODO
 * @Author wangjing
 * @Date 2020/12/23
 * @Version V1.0
 **/

@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new
                UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```

#### 4.1.5 vue项目

##### 4.1.5.1 Category.vue

![image-20210106080917524](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210106080917524.png)

![image-20210106081224578](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210106081224578.png)

删除line:5和line:22

```
<template>
	<v-card>
		<v-flex xs12 sm10>
			<v-tree url="/category/list"
                :isEdit="isEdit"
                @handleAdd="handleAdd"
                @handleEdit="handleEdit"
                @handleDelete="handleDelete"
                @handleClick="handleClick"
			/>
		</v-flex>
	</v-card>
</template>

<script>
    //import {treeData} from '../../mockDB'
    export default {
    	name: "category",
    	data() {
    		return {
   				isEdit:true
    		}
    	},
    	methods: {
    		handleAdd(node) {
                console.log("add .... ");
                console.log(node);
    		},
    		handleEdit(id, name) {
    			console.log("edit... id: " + id + ", name: " + name)
    		},
    		handleDelete(id) {
    			console.log("delete ... " + id)
    		},
    		handleClick(node) {
    			console.log(node)
    		}
    	}
    };
</script>
<style scoped>
</style>

```

##### 4.1.5.2 Tree.vue

```
<template>
  <v-list class="pt-0 pb-0" dense>
    <TreeItem
      class="item" :model="model" v-for="(model, index) in db" :key="index"
      :url="url"
      :isEdit="isEdit"
      :nodes="nodes"
      @handleAdd="handleAdd"
      @handleEdit="handleEdit"
      @handleDelete="handleDelete"
      @handleClick="handleClick"
    />
  </v-list>
</template>

<script>
  import TreeItem from './TreeItem';

  export default {
    name: "vTree",
    props: {
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      treeData:{
        type:Array
      }
    },
    data() {
      return {
        db: [],
        nodes:{
          opened:null,
          selected:{isSelected:false}
        }
      }
    },
    components: {
      TreeItem
    },
    created() {
      if(this.treeData && this.treeData.length > 0){
        this.db = this.treeData;
        return;
      }
      this.getData();
    },
    methods: {
      getData() {
        this.$http.get(this.url, {params: {pid: 0}}).then(resp => {
          console.log(resp)
          this.db = resp.data.data;
          this.db.forEach(n => n['path'] = [n.name])
        })
      },
      handleAdd(node) {
        this.$emit("handleAdd", this.copyNodeInfo(node));
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleDelete(id) {
        this.deleteById(id, this.db);
        this.$emit("handleDelete", id);
      },
      handleClick(node){
        this.$emit("handleClick", this.copyNodeInfo(node))
      },
      // 根据id删除
      deleteById(id, arr) {
        let src = arr & this.db;
        for (let i in src) {
          let d = src[i];
          if (d.id === id) {
            src.splice(i, 1)
            return;
          }
          if (d.children && d.children.length > 0) {
            this.deleteById(id, d.children)
          }
        }
      },
      copyNodeInfo(node){
        const o = {};
        for(let i in node){
          o[i] = node[i];
        }
        return o;
      }
    },
    watch: {}
  }
</script>

<style scoped>
  .item {
    cursor: pointer;
  }
</style>
```

##### 4.1.5.3 TreeItem.vue

```
<template>
  <div>
    <v-list-tile
      @click="toggle" class="level1 pt-0 pb-0 mt-0 mb-0" :class="{'selected':isSelected}">
      <v-list-tile-avatar>
        <v-icon v-if="model.isParent">{{open ? 'folder_open' : 'folder'}}</v-icon>
        <v-icon v-if="!model.isParent">insert_drive_file</v-icon>
      </v-list-tile-avatar>
      <v-list-tile-content>
        <v-list-tile-title v-show="!beginEdit">
          <span >{{model.name}}</span>
        </v-list-tile-title>
        <input v-show="beginEdit" @click.stop="" :ref="model.id" v-model="model.name"
               @blur="afterEdit" @keydown.enter="afterEdit"/>
      </v-list-tile-content>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c1='primary'" @mouseout="c1=''" :color="c1" @click.stop="addChild">
          <i class="el-icon-plus"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c2='success'" @mouseout="c2=''" :color="c2" @click.stop="editChild">
          <i class="el-icon-edit"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c3='error'" @mouseout="c3=''" :color="c3" @click.stop="deleteChild">
          <i class="el-icon-delete"/>
        </v-btn>
      </v-list-tile-action>
    </v-list-tile>

    <v-list v-if="isFolder" v-show="open" class="ml-4 pt-0 pb-0" dense transition="scale-transition">
      <tree-item
        class="item"
        v-for="(model, index) in model.children"
        :key="index"
        :model="model"
        :url="url"
        :isEdit="isEdit"
        :nodes="nodes"
        :parentState="open"
        @handleAdd="handleAdd"
        @handleEdit="handleEdit"
        @handleDelete="handleDelete"
        @handleClick="handleClick"
      >
      </tree-item>
    </v-list>
  </div>
</template>

<script>
  import Vue from 'vue'

  export default {
    name: "tree-item",
    props: {
      model: Object,
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      nodes: Object,
      parentState:Boolean
    },
    created() {
    },
    data: function () {
      return {
        c1: '',
        c2: '',
        c3: '',
        isSelected: false,
        open:false,
        beginEdit:false
      }
    },
    watch:{
      parentState(val){
        if(!val){
          this.open = val;
        }
      }
    },
    computed: {
      isFolder: function () {
        return this.model.children &&
          this.model.children.length > 0
      }
    },
    methods: {
      toggle: function () {
        // 将其它被选中项取消选中
        this.nodes.selected.isSelected = false;
        // 当前项被选中
        this.isSelected = true;
        // 保存当前选中项
        this.nodes.selected = this

        // 客户自己的点击事件回调
        this.handleClick(this.model);

        // 判断是否为顶级节点，顶级节点需要记录和替换
        if(this.model.parentId == 0){
          // 判断打开节点是否是自己
          if(this.nodes.opened && this != this.nodes.opened){
            // 不是，则关闭原来的节点
            this.nodes.opened.open = false;
          }
          // 将自己记录为打开的节点
          this.nodes.opened = this;
        }
        // 切换开闭状态
        this.open = !this.open;
        // 如果已经是叶子节点,或者自己是关闭的，或者自己已经有儿子了，结束
        if (!this.model.isParent || this.isFolder || !this.open) {
          return;
        }
        // 展开后查询子节点
        this.$http.get(this.url, {params: {pid: this.model.id}})
          .then(resp => {
          Vue.set(this.model, 'children', resp.data.data);
          // 封装当前节点的路径
          this.model.children.forEach(n => {
            n['path'] = [];
            this.model.path.forEach(p => n['path'].push(p));
            n['path'].push(n.name);
          });
        }).catch( e => {
          console.log(e);
        });
      },
      addChild: function () {
        let child = {
          id: 0,
          name: '新的节点',
          parentId: this.model.id,
          isParent: false,
          sort:this.model.children? this.model.children.length + 1:1
        }
        if (!this.model.isParent) {
          Vue.set(this.model, 'children', [child]);
          this.model.isParent = true;
          this.open = true;
          this.handleAdd(child);
        } else {
          if (!this.isFolder) {
            this.$http.get(this.url, {params: {pid: this.model.id}}).then(resp => {
              Vue.set(this.model, 'children', resp.data);
              this.model.children.push(child);
              this.open = true;
              this.handleAdd(child);
            });
          } else {
            this.model.children.push(child);
            this.open = true;
            this.handleAdd(child);
          }
        }
      },
      deleteChild: function () {
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
      editChild() {
        this.beginEdit = true;
        this.$nextTick(() => this.$refs[this.model.id].focus());
      },
      afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
      handleAdd(node) {
        this.$emit("handleAdd", node);
      },
      handleDelete(id) {
        this.$emit("handleDelete", id);
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleClick(node) {
        this.$emit("handleClick", node);
      }
    }
  }
</script>

<style scoped>
  .level1 {
    height: 40px;
  }

  .selected {
    background-color: rgba(105,184,249,0.75);
  }
</style>
```

依次启动eureka-server,xxx-service,zuul-server,vue项目 保证自己的hosts,nginx没有问题浏览器输入

### 4.2 商品删除

#### 后台

mingrui-shop-service-api-xxx

service：CategoryService

```
@ApiOperation(value = "删除商品分类")
@DeleteMapping(value = "category/del")
Result<JsonObject> delCategory(Integer id);
```

mingrui-shop-common-core

util：新建ObjectUtil

```
package com.baidu.shop.utils;

public class ObjectUtil {
    public static  Boolean isNull(Object obj){
        return null == obj;
    }
    public static Boolean isNotNull(Object obj){
        return null != obj;
    }
}
```

mingrui-shop-service-api-xxx新建com.baidu.shop.status

HTTPStatus

```
package com.baidu.shop.status;

public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
}
```

实现类中要做的事:

 通过当前id查询分类信息

 判断是否有数据(安全) 

判断当前节点是否是父级节点(安全) 

判断当前节点的父节点下 除了当前节点是否还有别的节点(业务) 

​		没有:将当前节点的父节点isParent的值修改为0 

通过id删除数据

代码实现CategoryServiceImpl

```
//商品删除
@Transactional//事务 增删改都需要
@Override
public Result<JsonObject> delCategory(Integer id) {

    String msg = "";

    System.out.println(id);
    //判断页面传递过来的id是否合法
    if(null != id && id >0){
        //通过id查询当前节点信息
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        //判断当前节点是否为父节点(安全!)
        if (categoryEntity.getParentId() == 1)return this.setResultError("当前是父节点不能删除");//return之后的代码不会执行

        //如果当前分类被品牌绑定的话不能被删除 --> 通过分类id查询中间表是否有数据 true : 当前分类不能被删除 false:继续执行
        Example example1 = new Example(CategoryBrandEntity.class);
        example1.createCriteria().andEqualTo("categoryId",id);
        List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
        if (categoryBrandEntities.size() > 0){
            return this.setResultError("当前分类被品牌绑定不能被删除 ");
        }


        //通过当前节点的父节点id 查询 当前节点(将要被删除的节点)的父节点下是否还有其他子节点
        Example example = new Example(CategoryEntity.class);
        example.createCriteria().andEqualTo("parentId",categoryEntity.getParentId());
        List<CategoryEntity> categoryList = categoryMapper.selectByExample(example);


        //如果size <= 1 --> 如果当前节点被删除的话 当前节点的父节点下没有节点了 --> 将当前节点的父节点状态改为叶子节点
        if (categoryList.size() <= 1){
            CategoryEntity updateCategoryEntity= new CategoryEntity();
            updateCategoryEntity.setParentId(0);
            updateCategoryEntity.setId(categoryEntity.getParentId());

            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
        }
        categoryMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
    return this.setResultError("id不合理");
}
```

#### 前台

TreeItem.vue : line 164

```
deleteChild: function () {
        if(this.model.isParent == 1){
          this.$message.warning('当前为父节点,不能删除');
          return;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
```

Category.vue

```
handleDelete(id) {
        this.$http.delete('./category/del?id=' + id).then(resp=>{

            if(resp.data.code != 200){
              this.$message.error('删除失败：' + resp.data.message);
              return;
            }

            this.editKey = new Date().getTime();
            this.$message.success('删除成功')
        }).catch(error => console.log(error))
      },
```

注意需要给v-tree组件绑定一个key的属性,默认值为0

```
<v-tree :key="key" url="/category/list">
    data() {
        return {
        	key:0
    	}
    }
```

### 4.3 商品修改

#### 后台

mingrui-shop-service-api-xxx

service：CategoryService

```
@ApiOperation(value = "修改商品分类")
@PutMapping(value = "category/edit")
Result<JsonObject> editCategory( @RequestBody CategoryEntity entity);
```

mingrui-shop-service-xxx

代码实现CategoryServiceImpl

```
//修改商品分类
@Transactional
@Override
public Result<JsonObject> editCategory(CategoryEntity entity) {
    try {
        categoryMapper.updateByPrimaryKeySelective(entity);
    } catch (Exception e) {
        e.printStackTrace();
    }
    return this.setResultSuccess();
}
```

#### 前台

将TreeItem.vue的afterEdit方法this.model.beginEdit改为 this.beginEdit

```
afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
```

Category.vue

```
handleEdit(id, name) {
        console.log("edit... id: " + id + ", name: " + name)
        this.$http.put('./category/edit',{
          id:id,
          name:name
        }).then(resp=>{
          this.$message.success('修改成功')
          this.editKey = new Date().getTime();
        }).catch(error => console.log(error))
      },
```

### 4.4 商品新增

#### 后台

mingrui-shop-service-api-xxx

service：CategoryService

```
@ApiOperation(value = "增加商品分类")
@PostMapping(value = "category/add")
Result<JsonObject> addCategory(@RequestBody CategoryEntity entity);
```

mingrui-shop-service-xxx

实现代码：CategoryServiceImpl

```
//新增商品分类
@Transactional
@Override
public Result<JsonObject> addCategory(CategoryEntity entity) {

    CategoryEntity parentCategoryEntity = new CategoryEntity();
    parentCategoryEntity.setId(entity.getParentId());
    parentCategoryEntity.setIsParent(1);
    categoryMapper.updateByPrimaryKeySelective(parentCategoryEntity);

    categoryMapper.insertSelective(entity);

    return this.setResultSuccess();
}
```

#### 前台

Category.vue

```
handleAdd(node) {
        console.log("add .... ");


        //处理boolean值
        node.isParent = node.isParent?1:0;
        //删除id属性
        delete node.id;
                console.log(node);
        //新增
        this.$http.post('./category/add',node).then(resp=>{
            this.$message.success('新增成功')
            this.editKey = new Date().getTime();
        }).catch(error=>console.log(error)
      },
```

### 4.5 项目不完美

common-core工程新建包com.baidu.shop.validate.group

包下新建操作类MingruiOperation

```
package com.baidu.shop.validate.group;

public class MingruiOperation {
    public interface Add{}
    public interface Update{}
    public interface Search{}
}
```

mingrui-shop-service-api-xxx

com.baidu.shop.entity

```
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    @NotNull(message = "ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类名称")
    @NotEmpty(message = "分类名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父级分类",example = "1")
    @NotNull(message = "父类ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    @NotNull(message = "是否为父节点不能为空",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    @NotNull(message = "排序字段不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}
```

 service：

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.models.auth.In;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;


@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

    @ApiOperation(value = "删除商品分类")
    @DeleteMapping(value = "category/del")
    Result<JsonObject> delCategory(Integer id);

    @ApiOperation(value = "修改商品分类")
    @PutMapping(value = "category/edit")
    Result<JsonObject> editCategory(@Validated({MingruiOperation.Update.class}) @RequestBody CategoryEntity entity);

    @ApiOperation(value = "增加商品分类")
    @PostMapping(value = "category/add")
    Result<JsonObject> addCategory(@Validated({MingruiOperation.Add.class})@RequestBody CategoryEntity entity);

    @ApiOperation(value = "通过品牌id查询商品分类")
    @GetMapping(value = "category/getByBrand")
    Result<List<CategoryEntity>> getByBrand (Integer brandId);
}
```

#### 全局异常处理

mingrui-shop-common-core

pom.xml

```
<!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
```

com.baidu.shop.staus:HTTPStatus

```
public static final int PARAMS_VALIDATE_ERROR = 5002;//参数校验失败
```

新建包com.baidu.shop.global

新建全局异常处理类GlobalException

```
package com.baidu.shop.global;

import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.google.gson.JsonObject;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.stream.Collectors;

@RestControllerAdvice
@Slf4j
public class globalException {
    @ExceptionHandler(value = RuntimeException.class)
    public Result<JsonObject> testException(RuntimeException e){
        log.error("code : {}, message : {}", HTTPStatus.ERROR,e.getMessage());
        return new Result<JsonObject>(HTTPStatus.ERROR,e.getMessage(),null);
    }
    @ExceptionHandler(value = MethodArgumentNotValidException.class)
    public HashMap<String, Object> methodValid(MethodArgumentNotValidException exception) throws Exception{
        //== ===区别？？
        HashMap<String, Object> map = new HashMap<>();
        map.put("code",HTTPStatus.PARAMS_VALIDATE_ERROR);

       List<String> msgList = new ArrayList<>();

       exception.getBindingResult().getFieldErrors().stream().forEach(error ->{
           msgList.add("Field -->" + error.getField() + ":" + error.getDefaultMessage());
           log.error("Field -->" + error.getField() + ":" + error.getDefaultMessage());
       });
        String message = msgList.parallelStream().collect(Collectors.joining(","));

        map.put("massage",message);

        return map;
    }
}
```

## 5 品牌管理

### 1.品牌查询

#### 后台

mingrui-shop-common-core

pom.xml

```
<!--帮助开发人员快速生成API文档-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
    <version>2.9.2</version>
</dependency>
```

com.baidu.shop.validate.group

 MingruiOperation

```
public interface Search{}
```

在com.baidu.shop.base包下新建BaseDTO

```
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页显示多少条",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrder() {
        return sort + " " + (Boolean.valueOf(order) ? "desc":"asc");
    }
}
```

mingrui-shop-service-api

pom.xml

```
<!--分页工具-->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.2.10</version>
</dependency>
```

mingrui-shop-service-api-xxx

在com.baidu.shop下新建dto包

新建BrandDto

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@Data
@ApiModel(value = "品牌DTO")
public class BrandDto extends BaseDTO {

    @ApiModelProperty(value = "品牌ID",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称",example = "1")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Add.class, MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "品牌图片")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;
}
```

com.baidu.shop.service包下新建BrandService

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "品牌接口")
public interface BrandService {
    @GetMapping(value = "brand/list")
    @ApiOperation(value = "查询品牌列表")
    Result<List<BrandEntity>> getBrandInfo(BrandDto brandDto);
}
```

mingrui-shop-service-xxx

在mapper包下新建BrandMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;

public interface BrandMapper extends Mapper<BrandEntity> {
}
```

com.baidu.shop.service.impl

新建BrandServiceImpl

```
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.service.BrandService;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService{

    @Autowired
    private BrandMapper brandMapper;

    //查询品牌
    @Override
    public Result<List<BrandEntity>> getBrandInfo(BrandDto brandDto) {
        //mybatis如何自定义分页插件 --》 mybatis执行器
        PageHelper.startPage(brandDto.getPage(),brandDto.getRows());
        if (!StringUtils.isEmpty(brandDto.getSort()))PageHelper.orderBy(brandDto.getOrder());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto, BrandEntity.class);

        Example example = new Example(BrandEntity.class);
        example.createCriteria().andLike("name","%" + brandEntity.getName() + "%");

        List<BrandEntity> brandEntities = brandMapper.selectByExample(example);
        PageInfo<BrandEntity> pageInfo = new PageInfo<>(brandEntities);
        return this.setResultSuccess(pageInfo);
    }
```

#### 前台

官网地址: 

表格:https://v15.vuetifyjs.com/zh-Hans/components/data-tables 

输入框:https://v15.vuetifyjs.com/zh-Hans/components/snackbars 

按钮:https://v15.vuetifyjs.com/zh-Hans/components/buttons

在item包下新建MrBrand.vue

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
```

index.js line : 27

```
route("/item/brand",'/item/MrBrand',"MrBrand"),
```

### 2.品牌新增

#### 后台

mingrui-shop-common-core

在utils包下新建BaiduBeanUtil

```
package com.baidu.shop.utils;

import org.springframework.beans.BeanUtils;

public class BaiduBeanUtil<T>{
    public static <T> T copyProperties(Object source,Class<T> tClass) {
        T t=null;
        try {
            t = tClass.newInstance();//创建实例
            BeanUtils.copyProperties(source, t);
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
        return t;
    }
}
```

mingrui-shop-service-api-xxx

com.baidu.shop.dto BrandDto

```
@ApiModelProperty(value = "品牌分类信息")
@NotEmpty(message = "品牌分类信息不能为空",groups = {MingruiOperation.Add.class})
private String categories;
```

com.baidu.shop.entity包下新建CategoryBrandEntity

```
package com.baidu.shop.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Table;

@Data
@Table(name = "tb_category_brand")
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {
    private Integer categoryId;

    private Integer brandId;
}
```

com.baidu.shop.service：BrandService

```
@PostMapping(value = "brand/save")
@ApiOperation(value = "新增品牌")
Result<JsonObject> save(@RequestBody BrandDto brandDto);
```

mingrui-shop-service-xxx

在mapper包下新建CategoryBrandMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryBrandEntity;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

public interface CategoryBrandMapper extends InsertListMapper<CategoryBrandEntity>, Mapper<CategoryBrandEntity> {
}
```

com.baidu.shop.service.impl：BrandServiceImpl

```
//新增品牌
    @Transactional
    @Override
    public Result<JsonObject> save(BrandDto brandDto) {

        //新增返回主键?
        //两种方式实现 select-key insert加两个属性
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto,BrandEntity.class);
        //处理品牌首字母
        brandDto.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandDto.getName().charAt(0)),PinyinUtil.TO_FUUL_PINYIN).charAt(0));

        brandMapper.insertSelective(brandEntity);
        //维护中间表数据
        this.insetrCategoryBrandList(brandDto.getCategories(),brandEntity.getId());
        return this.setResultSuccess();
    }
```

```
//新增修改整合
private void insetrCategoryBrandList (String categories,Integer brandId){
    if (StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");

    //判断分类集合字符串中是否包含,
    if(categories.contains(",")){
        categoryBrandMapper.insertList(
            //数组转list
            Arrays.asList(categories.split(","))
                    //获取stream流，流：对一次数据进行操作
                    .stream()
                    //遍历list中所有数据
                    .map(categoryById->new CategoryBrandEntity(Integer.valueOf(categoryById),brandId))
                    //最终转换成list
                    .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);

        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

#### 前台

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
```

Casecader.vue需要修改113行

MrBrand.vue

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
```

#### 新增遗留的问题

品牌首字母自动识别

##### 后台

mingrui-shop-common-core

pom.xml

```
<dependency>
    <groupId>com.belerweb</groupId>
    <artifactId>pinyin4j</artifactId>
    <version>2.5.1</version>
</dependency>
```

com.baidu.shop.utils包下新建PinyinUtil

```
package com.baidu.shop.utils;

import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


public class PinyinUtil {
    public static final Boolean TO_FUUL_PINYIN = true;
    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }
    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }
    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi 汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
/***
 * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
 * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
 * ^[\u4E00-\u9FA5]+$ 匹配简体
 */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
//是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }
    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }
    /***
     * 匹配
     * <P>
     * 根据字符和正则表达式进行匹配
     *
     * @param str 源字符串
    4.1.3 mingrui-shop-service-xxx
    4.1.3.1 BrandServiceImpl
     * @param regex 正则表达式
     *
     * @return true：匹配成功 false：匹配失败
     */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl

```
@Override
public Result<JSONObject> save(BrandDTO brandDTO) {
    //str.charAt(0)获取当前字符串第一个字符
    //String.valueOf()将对象转换为String类型的字符串
    //
    // char c = brandDTO.getName().charAt(0);
    // String s = String.valueOf(c);
    // String upperCase = PinyinUtil.getUpperCase(s,
    PinyinUtil.TO_FIRST_CHAR_PINYIN);
    // char c1 = upperCase.charAt(0);
    // brandDTO.setLetter(c1);
    brandDTO.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandDTO.getName().ch
    arAt(0)),PinyinUtil.TO_FIRST_CHAR_PINYIN).charAt(0));
    try {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,
        BrandEntity.class);
        //通用mapper新增返回主键
        brandMapper.insertSelective(brandEntity);
            //绑定关系
            if(StringUtils.isEmpty(brandDTO.getCategories())){
            	return this.setResultError("分类数据不能为空");
            }
            if(brandDTO.getCategories().contains(",")){
                List<CategoryBrandEntity> list = new ArrayList<>();
                String[] categoryArr = brandDTO.getCategories().split(",");
                Arrays.asList(categoryArr).stream().forEach(str -> {
                    CategoryBrandEntity categoryBrandEntity = new
                    CategoryBrandEntity();
                    categoryBrandEntity.setBrandId(brandEntity.getId());
                    categoryBrandEntity.setCategoryId(Integer.parseInt(str));
                    list.add(categoryBrandEntity);
            	});
   	 		categoryBrandMapper.insertList(list);
    		}
    } catch (Exception e) {
   	 	e.printStackTrace();
    }
    return this.setResultSuccess();
}
```

##### 前台

将MrBrandForm.vue组件中所有关于首字母的内容删除掉

```
<template>
    <div>
            <v-form v-model="valid" ref="form">
                <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                <!-- 文件上传 -->
                <v-layout row>
                    <v-flex xs3>
                      <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                    </v-flex>
                    <v-flex>
                        <v-upload
                          v-model="brand.image"
                          url="/upload"
                          :multiple="false"
                          :pic-width="250"
                          :pic-height="100"
                        />
                    </v-flex>
                </v-layout> 
            </v-form>
         <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn small @click="cancel()">取消</v-btn>
          <v-btn small color="red"  @click="submitForm">确认</v-btn>
        </v-card-actions>
    </div>
</template>
<script>
  export default {
    name:"MrBrandForm",
    props:{
      //父组件传递过来的模态框状态
      dialog: Boolean,
      brandDetail: Object,
      isEdit: Boolean
    },
    watch:{
      dialog(val){
        if(val) this.$refs.form.reset();
      },
      brandDetail(val){
        if(this.isEdit){
            this.$http.get('category/getByBrand',{
              params:{
                brandId:val.id
              }
            }).then(resp =>{
              console.log(resp);
              let brand = val;
              brand.categories = resp.data.data;
              this.brand = brand;
            }).catch(error => console.log(error))
            // this.brand=val;
        }
      }
    },
    data () {
      //在js中 null == false , '' == false , undefined == false , 0 == false
      return {
        valid: true,
        nameRules:[
          (v) => !!v || '品牌名称不能为空',
          (v) => (v && v.length <= 10) || '品牌名称长度最长10'
        ],
        brand:{
            name:"",
            letter:"",
            categories:[],
          
        }
      }
    },
    methods:{
        cancel(){
            this.$emit("closeDialog");
        },
        submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
    }   
  }
</script>
```

#### 清空form和表单验证的问题

##### 前台

MrBrand.vue

```
<mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
```

MrBrandFrom.vue

```
<template>
    <div>
            <v-form v-model="valid" ref="form">
                <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                <!-- 文件上传 -->
                <v-layout row>
                    <v-flex xs3>
                      <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                    </v-flex>
                    <v-flex>
                        <v-upload
                          v-model="brand.image"
                          url="/upload"
                          :multiple="false"
                          :pic-width="250"
                          :pic-height="100"
                        />
                    </v-flex>
                </v-layout> 
            </v-form>
         <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn small @click="cancel()">取消</v-btn>
          <v-btn small color="red"  @click="submitForm">确认</v-btn>
        </v-card-actions>
    </div>
</template>
<script>
  export default {
    name:"MrBrandForm",
    props:{
      //父组件传递过来的模态框状态
      dialog: Boolean,
      brandDetail: Object,
      isEdit: Boolean
    },
    watch:{
      dialog(val){
        if(val) this.$refs.form.reset();
      },
      brandDetail(val){
        if(this.isEdit){
            this.$http.get('category/getByBrand',{
              params:{
                brandId:val.id
              }
            }).then(resp =>{
              console.log(resp);
              let brand = val;
              brand.categories = resp.data.data;
              this.brand = brand;
            }).catch(error => console.log(error))
            // this.brand=val;
        }
      }
    },
    data () {
      //在js中 null == false , '' == false , undefined == false , 0 == false
      return {
        valid: true,
        nameRules:[
          (v) => !!v || '品牌名称不能为空',
          (v) => (v && v.length <= 10) || '品牌名称长度最长10'
        ],
        brand:{
            name:"",
            letter:"",
            categories:[],
          
        }
      }
    },
    methods:{
        cancel(){
            this.$emit("closeDialog");
        },
        submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
    }   
  }
</script>
```

Cascader.vue(bug) line:162

```
if(val && this.showAllLevels && !this.multiple){
            this.selected = [val.map(o => o[this.itemText]).join("/")]
          } else if (this.multiple && typeof val == 'object') {
            this.selected = val.map(o => {
              return {
                label: o[this.itemText],
                value: o[this.itemValue]
              }
            })
          } else {
            if(typeof val == 'object'){
              this.selected = [val[this.itemText]]
            }
          }
```

#### 上传图片

##### 后台

在mingrui-shop-basics下新建mingrui-shop-basic-uploadserver

pom.xml

```
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shop-common-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dpendencies>
```

application.yml



```
server:
  port: 8200
spring:
  application:
    name: upload-server
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka

mingrui:
  upload:
    path:
      windows: F:\\images
      linux: /wangjing/images
    img:
      host: http://49.233.3.39/
```

com.baidu新建启动类RunBasicUploadServer

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableEurekaClient
public class RunBasicUploadServer {
    public static void main(String[] args) {
        SpringApplication.run(RunBasicUploadServer.class);
    }
}
```

新建包com.baidu.shop.upload.controller新建UploadController

```
package com.baidu.shop.upload.controller;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.io.File;
import java.io.IOException;
import java.util.UUID;


@RestController
@RequestMapping(value = "upload")
public class UploadController extends BaseApiService {

    //linux系统的上传目录
    @Value(value = "${mingrui.upload.path.windows}")
    private String windowsPath;
    //window系统的上传目录
    @Value(value = "${mingrui.upload.path.linux}")
    private String linuxPath;
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) {
        if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的文件是否为空
        String filename = file.getOriginalFilename();//获取文件名
        String path = "";
        String os = System.getProperty("os.name").toLowerCase();
        if(os.indexOf("win") != -1){
            path = windowsPath;
        }else if(os.indexOf("lin") != -1){
            path = linuxPath;
        }
        filename = UUID.randomUUID() + filename;//防止文件名重复
//创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
        File dest = new File(path + File.separator + filename);
//判断文件夹是否存在,不存在的话就创建
        if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();
        try {
            file.transferTo(dest);//上传
        } catch (IllegalStateException e) {
// TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
// TODO Auto-generated catch block
            e.printStackTrace();
        }
        return this.setResult(HTTPStatus.OK,"upload success!!!",imgHost + "/" +
                filename);//将文件名返回页面用于页面回显
    }
}
```

新建包:com.baidu.global新建GlobalCorsConfig

```
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;


@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```

使用postman测试上传

post请求localhost:8200(端口)/upload(UploadController方法名)

hosts文件中新增

```
127.0.0.1 image.mrshop.com
```

nginx-home/conf/nginx.conf新增

```
server { 
	listen 80; 
	server_name image.mrshop.com; 
	
	proxy_set_header X-Forwarded-Host $host; 
	proxy_set_header X-Forwarded-Server $host; 
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
	location ~ .*\.(gif|jpg|pdf|jpeg|png)$ { 
        #root D:/nginx-1.15.5/temp/images/;#指定图片存放路径(可以放在nginx文件夹路 径里也可以放其他p盘) root 				E:\images; 
	} 
		location / { 
			root html; 
			index index.html index.htm; 
		} 
	}
```

重启nginx

```
nginx.exe -s reload
```

浏览器输入http://image.mrshop.com/imageName.jpg测试

启动vue项目测试不能成功,还是请求了网关,

网关会把api-xxx的请求转发到service-xxx的服务中,而service-xxx并没有 upload服务 

所以我想只要包含/upload请求的我都不进行路由

mingrui-shop-basic-zuul-server的application.yml

```
zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server
```

在nginx-home/conf/nginx.conf 添加api.mrshop.com的代理配置

```
# 上传路径的映射 
# 只要包含/api-xxx/upload 都会把请求映射到8200服务 
# rewrite "^/api-xxx/(.*)$" /$1 break;
# 将/api-xxx 替换成/ 
location /api-xxx/upload { 
	proxy_pass http://127.0.0.1:8200; 
	proxy_connect_timeout 600; 
	proxy_read_timeout 600; rewrite "^/api-xxx/(.*)$" /$1 break; 
}
```

重启nginx

### 3.品牌修改

#### 回显

##### 后台

mingrui-shop-service-api-xxx

Service：CategoryService

```
@ApiOperation(value = "通过品牌id查询商品分类")
@GetMapping(value = "category/getByBrand")
Result<List<CategoryEntity>> getByBrand (Integer brandId);
```

mingrui-shop-service-xxx

com.baidu.shop.mapper：CategoryMapper

```
@Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
```

com.baidu.shop.service.impl：CategoryServiceImpl

```
//通过品牌查询商品id
@Override
public Result<List<CategoryEntity>> getByBrand(Integer brandId) {
    List<CategoryEntity> byBrandId = categoryMapper.getByBrandId(brandId);
    return this.setResultSuccess(byBrandI);
}
```

##### 前台

 MrBrand.vue

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
```

MrBrandForm.vue

```
<template>
    <div>
            <v-form v-model="valid" ref="form">
                <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                <!-- 文件上传 -->
                <v-layout row>
                    <v-flex xs3>
                      <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                    </v-flex>
                    <v-flex>
                        <v-upload
                          v-model="brand.image"
                          url="/upload"
                          :multiple="false"
                          :pic-width="250"
                          :pic-height="100"
                        />
                    </v-flex>
                </v-layout> 
            </v-form>
         <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn small @click="cancel()">取消</v-btn>
          <v-btn small color="red"  @click="submitForm">确认</v-btn>
        </v-card-actions>
    </div>
</template>
<script>
  export default {
    name:"MrBrandForm",
    props:{
      //父组件传递过来的模态框状态
      dialog: Boolean,
      brandDetail: Object,
      isEdit: Boolean
    },
    watch:{
      dialog(val){
        if(val) this.$refs.form.reset();
      },
      brandDetail(val){
        if(this.isEdit){
            this.$http.get('category/getByBrand',{
              params:{
                brandId:val.id
              }
            }).then(resp =>{
              console.log(resp);
              let brand = val;
              brand.categories = resp.data.data;
              this.brand = brand;
            }).catch(error => console.log(error))
            // this.brand=val;
        }
      }
    },
    data () {
      //在js中 null == false , '' == false , undefined == false , 0 == false
      return {
        valid: true,
        nameRules:[
          (v) => !!v || '品牌名称不能为空',
          (v) => (v && v.length <= 10) || '品牌名称长度最长10'
        ],
        brand:{
            name:"",
            letter:"",
            categories:[],
          
        }
      }
    },
    methods:{
        cancel(){
            this.$emit("closeDialog");
        },
        submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
    }   
  }
</script>
```

#### 修改

##### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：BrandService

```
@PutMapping(value = "brand/save")
@ApiOperation(value = "修改品牌")
Result<JsonObject> eidt(@RequestBody BrandDto brandDto);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：BrandServiceImpl

```
//修改品牌
@Transactional
@Override
public Result<JsonObject> eidt(BrandDto brandDto) {


    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto, BrandEntity.class);

    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);
    //先通过brandId删除中间表的数据
    this.delteCategoryByBrandId(brandEntity.getId());
    //批量新增 / 新增
    this.insetrCategoryBrandList(brandDto.getCategories(),brandEntity.getId());
    return this.setResultSuccess();
}
```

```
//新增修改整合
private void insetrCategoryBrandList (String categories,Integer brandId){
    if (StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");

    //判断分类集合字符串中是否包含,
    if(categories.contains(",")){
        categoryBrandMapper.insertList(
            //数组转list
            Arrays.asList(categories.split(","))
                    //获取stream流，流：对一次数据进行操作
                    .stream()
                    //遍历list中所有数据
                    .map(categoryById->new CategoryBrandEntity(Integer.valueOf(categoryById),brandId))
                    //最终转换成list
                    .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);

        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

##### 前台

```
submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
```

### 4.品牌删除

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：BrandService

```
@DeleteMapping(value = "brand/del")
@ApiOperation(value = "删除品牌")
Result<JsonObject> del( Integer id);
```

mingrui-shop-service-xxx：BrandServiceImpl

```java
//删除品牌
@Override
public Result<JsonObject> del(Integer id) {
    //删除品牌信息
    brandMapper.deleteByPrimaryKey(id);
    this.delteCategoryByBrandId(id);
    return this.setResultSuccess();
}

private void  delteCategoryByBrandId (Integer brandId){
    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",brandId);
    categoryBrandMapper.deleteByExample(example);
}
```

##### 前台

```
<v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
```

```
delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
```

## 6 规格参数

### 1.规格组(查询)

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.entity新建：SpecGroupEntity

```
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {
    @Id
    private Integer id;

    private Integer cid;

    private String name;
}
```

com.baidu.shop.dto新建：SpecGroupDto

```
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "规格分组")
@Data
public class SpecGroupDto extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类型id",example = "1")
    @NotNull(message = "类型id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称",example = "1")
    @NotEmpty(message = "规格组名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;
}
```

com.baidu.shop.service新建：SpecGroupService

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDto;
import com.baidu.shop.entity.SpecGroupEntity;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiModelProperty;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(value ="规格组接口")
public interface SpecGroupService {

    @ApiModelProperty(value = "规格组查询")
    @GetMapping(value = "specGroup/getSpecGroupInfo")
    Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDto specGroupDto);
}
```

mingrui-shop-service-xxx

com.baidu.shop.mapper新建：SpecGroupMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecGroupEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecGroupMapper extends Mapper<SpecGroupEntity> {
}
```

com.baidu.shop.service.impl新建：SpecGroupServiceImpl

```
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import com.baidu.shop.mapper.SpecGroupMapper;
import com.baidu.shop.service.SpecificationService;
import com.baidu.shop.utils.ObjectUtil;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class SpecGroupServiceImpl extends BaseApiService implements SpecGroupService {

    @Resource
    private SpecGroupMapper specGroupMapper;
    
    //规格组查询
    @Override
    public Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDto specGroupDto) {
        Example example = new Example(SpecGroupEntity.class);

        if (ObjectUtil.isNotNull(specGroupDto.getCid()))
                example
                .createCriteria()
                .andEqualTo("cid", BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class).getCid());

        List<SpecGroupEntity> specGroupExample = specGroupMapper.selectByExample(example);
        return this.setResultSuccess(specGroupExample);
    }
}
```

#### 前台

加载分类信息

index.js line:29

```
route("/item/specification",'/item/specification/Specification',"Specification"),
```

 specification/Specification.vue

```
<v-tree url="/specGroup/getSpecGroupInfo" :isEdit="false" @handleClick="handleClick"/>
```

规格组(查询)

SpecGroup.vue

```
loadData(){
          this.$http.get("/specGroup/getSpecGroupInfo",{
              params:{
                  cid:this.cid
              }
          })
          .then((resp) => {
              this.groups = resp.data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```

### 2.规格组(新增,删除,修改)

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：SpecGroupService

```
@ApiModelProperty(value = "新增规格组")
@PostMapping(value = "specGroup/save")
Result<JsonObject> saveSpecGroup(@RequestBody SpecGroupDto specGroupDto);

@ApiModelProperty(value = "修改规格组")
@PutMapping(value = "specGroup/save")
Result<JsonObject> editSpecGroup(@RequestBody SpecGroupDto specGroupDto);

@ApiModelProperty(value = "删除规格组")
@DeleteMapping("specGroup/delete/{id}")
Result<JsonObject> delSpecRoupById(@PathVariable Integer id);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：SpecGroupServiceImpl

```
//规格组新增
@Transactional
@Override
public Result<JsonObject> saveSpecGroup(SpecGroupDto specGroupDto) {
    specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class));
    return this.setResultSuccess();
}

//规格组修改
@Override
public Result<JsonObject> editSpecGroup(SpecGroupDto specGroupDto) {
    specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class));
    return this.setResultSuccess();
}

//规格组删除

@Override
public Result<JsonObject> delSpecRoupById(Integer id) {
    //删除规格组之前要先判断一下当前规格组下是否有规格参数
    //true : 不能被删除
    //false -->
    Example example = new Example(SpecParamEntity.class);
    example.createCriteria().andEqualTo("groupId",id);
    List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
    if (specParamEntities.size() >0){
        return this.setResultError("当前规格组有数据不能被删除");
    }

    specGroupMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

#### 前台

SpecGroup.vue

```
 save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: 'specGroup/save',
            data: this.group
          }).then((resp) => {
            // 关闭窗口
            if(resp.data.code == 200){
                this.show = false;
                this.$message.success("保存成功！");
                this.loadData();
            }
           
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      },
      deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("/specGroup/delete/ " + id)
                .then((resp) => {
                    if(resp.data.code!=200){
                        this.$message.error(resp.data.message);
                        this.loadData();
                        return
                    }
                    this.loadData();
                    this.$message.success("删除成功")
                })
          })
      },
```

### 3. 规格参数(查询)

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.entity新建:SpecParamEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_param")
@Data
public class SpecParamEntity {

    @Id
    private Integer id;

    private Integer cid;

    private Integer groupId;

    private String name;

    @Column(name = "`numeric`")
    private Boolean numeric;

    private String unit;

    private Boolean generic;

    private Boolean searching;

    private String segments;
}
```

com.baidu.shop.dto新建:SpecParamDto

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;


import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@Data
@ApiModel(value = "规格参数")
public class SpecParamDto extends BaseDTO {
    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id",example = "1")
    @NotNull(message = "分类id不能为空",groups = {MingruiOperation.Update.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组id",example = "1")
    @NotNull(message = "规格组id不能为空",groups = {MingruiOperation.Update.class})
    private Integer groupId;

    @ApiModelProperty(value = "规格组参数名称",example = "1")
    @NotEmpty(message = "规格组参数名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value = "是否是数字类型参数，1->true或0->false",example = "0")
    @NotNull(message = "是否是数字类型参数不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean numeric;

    @ApiModelProperty(value = "数字类型参数的单位，非数字类型可以为空",example = "1")
    @NotEmpty(message = "数字类型参数的单位不能为空",groups = {MingruiOperation.Add.class})
    private String unit;

    @ApiModelProperty(value = "是否是sku通用属性，1->true或0->false",example = "0")
    @NotNull(message = "是否是sku通用属性不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean generic;

    @ApiModelProperty(value = "是否用于搜索过滤，true或false",example = "0")
    @NotNull(message = "是否用于搜索过滤不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean searching;

    @ApiModelProperty(value = "数值类型参数",example = "1")
    @NotEmpty(message = "数值类型参数不能为空",groups = {MingruiOperation.Add.class})
    private String segments;
}
```

com.baidu.shop.service新建:SpecParamService

```
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(value = "规格参数接口")
public interface SpecParamService {
    @ApiOperation(value = "查询规格参数")
    @GetMapping(value = "specParam/getSpecParamInfo")
    Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDto specParamDto);
}
```

mingrui-shop-service-xxx

com.baidu.shop.mapper包下新建SpecParamMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecParamEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecParamMapper extends Mapper<SpecParamEntity> {
    
}
```

com.baidu.shop.service.impl新建:SpecParamServiceImpl

```
@RestController
public class SpecParamServiceImpl extends BaseApiService implements SpecParamService {

    @Resource
    private SpecParamMapper specParamMapper;

    //查询规格参数
    @Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDto specParamDto) {
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamDto.getGroupId());
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        return this.setResultSuccess(specParamEntities);
    }
}
```

#### 前台

SpecParam.vue

```
loadData() {
      this.$http
        .get("/specParam/getSpecParamInfo",{
           params:{
             groupId:this.group.id
           }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
      
          this.params =resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
```

### 4.规格参数(增,删,改)

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：SpecParamService

```
@ApiOperation(value = "新增规格参数")
@PostMapping(value = "specParam/save")
Result<JsonObject> saveSpecParam(@RequestBody SpecParamDto specParamDto);

@ApiOperation(value = "修改规格参数")
@PutMapping(value = "specParam/save")
Result<JsonObject> editSpecParam(@RequestBody SpecParamDto specParamDto);

@ApiOperation(value = "删除规格参数")
@DeleteMapping(value = "specParam/delete")
Result<JsonObject> delSpecParam(Integer id);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：SpecParamServiceImpl

```
//新增规格参数
@Transactional
@Override
public Result<JsonObject> saveSpecParam(SpecParamDto specParamDto) {
    specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDto,SpecParamEntity.class));
    return this.setResultSuccess();
}

//新增规格参数
@Transactional
@Override
public Result<JsonObject> editSpecParam(SpecParamDto specParamDto) {
    specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDto,SpecParamEntity.class));
    return this.setResultSuccess();
}

//删除规格参数
@Transactional
@Override
public Result<JsonObject> delSpecParam(Integer id) {
    specParamMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

#### 前台

SpecParam.vue

```
methods: {
    loadData() {
      this.$http
        .get("/specParam/getSpecParamInfo",{
           params:{
             groupId:this.group.id
           }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
      
          this.params =resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
    editParam(param) {
        this.param = param;
        this.isEdit = true;
        this.show = true;
    },
    addParam() {
      this.param = {
          cid: this.group.cid,
          groupId: this.group.id,
          segments:[],
          numeric:false,
          searching:false,
          generic:false}
      this.show = true;
    },
    deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("/specParam/delete?id=" + id)
            .then((resp) => {
              if(resp.data.code == 200){
                  this.$message.success("删除成功");
                  this.loadData();
              } 
              
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
    formatBoolean(boo) {
      return boo ? "是" : "否";
    },
    save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specParam/save',
            data: p,
        }).then((resp) => {
            // 关闭窗口
            if(resp.data.code == 200){
                this.show = false;
                this.$message.success("保存成功！");
                this.loadData();
            }
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
  }
```

## 7 商品管理

### 1.查询

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.entity：新建 SpuEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Table(name = "tb_spu")
@Data
public class SpuEntity {
    @Id
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;
}
```

SpuDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * @ClassName SpuDTO
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/5
 * @Version V1.0
 **/

@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {
    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "主键不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空", groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id", example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id", example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id", example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    private Integer saleable;

    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    private Integer valid;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    private String categoryName;

    private String brandName;
}

```

GoodsService

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "商品接口")
public interface GoodsService {
    @ApiOperation(value = "查询spu信息")
    @GetMapping(value = "/goods/getSpuInfo")
    Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO);
}
```

GoodsServiceImpl

```
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.entity.SpuEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.mapper.SpuMapper;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @ClassName GoodsServiceImpl
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/5
 * @Version V1.0
 **/

@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {
    @Resource
    private SpuMapper spuMapper;

    @Resource
    private BrandMapper brandMapper;

    @Resource
    private CategoryMapper categoryMapper;

    @Override
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {
        if(ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());
        if(!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%" + spuDTO.getTitle() + "%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity,SpuDTO.class);
            //通过分类id集合查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(),spuEntity.getCid2(),spuEntity.getCid3()));

            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());
            return spuDTO1;
        }).collect(Collectors.toList());

        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal() + "",spuDTOList);
    }
}

```

CategoryMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.SelectByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface CategoryMapper extends Mapper<CategoryEntity>, SelectByIdListMapper<CategoryEntity,Integer> {
    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

#### 前台

Goods.vue

```
getDataFromApi() {
        this.loading = true;
        this.$http.get('/goods/getSpuInfo',{
          params:{
            page:this.pagination.page,
            rows:this.pagination.rowsPerPage,
            sort:this.pagination.sortBy,
            order:this.pagination.descending,
            saleable:this.search.saleable,
            title:this.search.key
          },
        }).then(resp => {
          // this.items = resp.data.data.list;
          this.items = resp.data.data;
          // this.totalItems = parseInt(resp.data.message);
          this.totalItems = resp.data.message - 0;
          this.loading = false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
```

### 2.新增（数据准备）

#### 前台

GoodsFrom.vue

line:20

```
<!--商品分类-->
<v-cascader
    url="/category/list"
    required
    showAllLevels
    v-model="goods.categories"
    label="请选择商品分类"/>
```

line:277

```
	handler(val) {
        console.log(val)
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/getSpecParamInfo",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
```

line:57

```
<!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
      </v-stepper-content>
```

line:118

```
<!--图片上传组件-->
<v-upload v-model="props.item.images" url="/upload"/>
```

line:206

```
images: images ? images.map(image => image.data).join(",") : '',
```

Editor.vue

line:93

```
this.$http.post(this.uploadUrl, data)
          .then(res => {
            if (res.data.data) {    this.editor.insertEmbed(this.editor.getSelection().index, 'image', res.data.data)
            }
          })
```

#### 后台

mingrui-shop-service-api-xxx

BrandService

```
@GetMapping(value = "brand/getBrandInfoByCategoryId")
@ApiOperation(value = "通过分类id查询品牌")
Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid);
```

mingrui-shop-service-xxx

BrandMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface BrandMapper extends Mapper<BrandEntity> {
    @Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
}
```

BrandServiceImpl

```
@Override
public Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid) {
    List<BrandEntity> list = brandMapper.getBrandInfoByCategoryId(cid);
    return this.setResultSuccess(list);
}
```

SpecParamServiceImpl

```
@Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {
        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
//        example.createCriteria().andEqualTo("groupId",specParamEntity.getGroupId());
        Example.Criteria criteria = example.createCriteria();

        if (ObjectUtil.isNotNull(specParamEntity.getGroupId()))
            criteria.andEqualTo("groupId",specParamEntity.getGroupId());
        if (ObjectUtil.isNotNull(specParamEntity.getCid()))
            criteria.andEqualTo("cid",specParamEntity.getCid());

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        return this.setResultSuccess(specParamEntities);
    }
```

###  3.新增（传值接值）

![image-20210108142909760](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108142909760.png)

#### 后台

mingrui-shop-service-api-xxx

新建SpuDetailEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName SpuDetailEntity
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/7
 * @Version V1.0
 **/

@Table(name = "tb_spu_detail")
@Data
public class SpuDetailEntity {
    @Id
    private Integer spuId;

    private String description;

    private String genericSpec;

    private String specialSpec;

    private String packingList;

    private String afterService;
}
```

新建SkuEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * @ClassName SkuEntity
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/7
 * @Version V1.0
 **/

@Table(name = "tb_sku")
@Data
public class SkuEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;
}
```

StockEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName StockEntity
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/7
 * @Version V1.0
 **/

@Table(name = "tb_stock")
@Data
public class StockEntity {
    @Id
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    private Integer stock;
}
```

dto包下新建

SpuDetailDTO

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName SpuDetailDTO
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/7
 * @Version V1.0
 **/

@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {
    @ApiModelProperty(value = "spu主键",example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;
}
```

SkuDTO

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.util.Date;

/**
 * @ClassName SkuDTO
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/7
 * @Version V1.0
 **/

@ApiModel(value = "SKU属性数据传输类")
@Data
public class SkuDTO {
    @ApiModelProperty(value = "主键", example = "1")
    private Long id;

    @ApiModelProperty(value = "spu主键", example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    private String title;

    @ApiModelProperty(value = "商品的图片，多个图片以‘,’分割")
    private String images;

    @ApiModelProperty(value = "销售价格，单位为分", example = "1")
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用linkedHashMap，保证有序")
    private String ownSpec;

    //注意此处使用boolean值来接,在service中处理一下就可以了
    @ApiModelProperty(value = "是否有效，0无效，1有效", example = "1")
    private Boolean enable;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    //方便接受页面传递过来的参数
    @ApiModelProperty(value = "库存")
    private Integer stock;
}
```

StockDTO

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName StockDTO
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/7
 * @Version V1.0
 **/

@ApiModel(value = "库存数据传输类")
@Data
public class StockDTO {
    @ApiModelProperty(value = "sku主键", example = "1")
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存", example = "1")
    private Integer seckillStock;

    @ApiModelProperty(value = "秒杀总数量", example = "1")
    private Integer seckillTotal;

    @ApiModelProperty(value = "库存数量", example = "1")
    private Integer stock;
}
```

修改SpuDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

/**
 * @ClassName SpuDTO
 * @Description: TODO
 * @Author wangjing
 * @Date 2021/1/5
 * @Version V1.0
 **/

@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {
    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "主键不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空", groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id", example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id", example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id", example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    private Integer saleable;

    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    private Integer valid;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    private String categoryName;

    private String brandName;

    @ApiModelProperty(value = "大字段数据")
    private SpuDetailDTO spuDetail;

    @ApiModelProperty(value = "sku属性数据集合")
    private List<SkuDTO> skus;
}
```

GoodsService

```
@ApiOperation(value = "新增商品")
@PostMapping(value = "/goods/save")
Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);
```

GoodsServiceImpl

```
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
    System.out.println(spuDTO);
    return this.setResultSuccess();
}
```

能正常接收到所有页面数据即可

### 4.新增（入库）

#### 前台

GoodsForm.vue

line:228

```
.then(() => {
    // 成功，关闭窗口
    this.$emit("closeForm");
    // 提示成功
    this.$message.success("保存成功了");
})
```

#### 后台

mingrui-shop-service-xxx

mapper包下新建

SpuDetailMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuDetailEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}
```

SkuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SkuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SkuMapper extends Mapper<SkuEntity> {
}
```

StockMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.common.Mapper;

public interface StockMapper extends Mapper<StockEntity> {
}
```

GoodsServiceImpl

```
@Resource
private CategoryMapper categoryMapper;

@Resource
private SpuDetailMapper spuDetailMapper;

@Resource
private SkuMapper skuMapper;

@Resource
private StockMapper stockMapper;

@Transactional
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
	System.out.println(spuDTO);
	//新增spu
	SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,
	SpuEntity.class);
    spuEntity.setSaleable(1);
    spuEntity.setValid(1);
    final Date date = new Date();//保持两个时间一致
    spuEntity.setCreateTime(date);
    spuEntity.setLastUpdateTime(date);
    spuMapper.insertSelective(spuEntity);
    
    //新增spuDetail
    SpuDetailEntity spuDetailEntity =
    BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(), SpuDetailEntity.class);
    spuDetailEntity.setSpuId(spuEntity.getId());
    spuDetailMapper.insertSelective(spuDetailEntity);
    
    //新增sku
    /*List<SkuEntity> skuEntities = spuDTO.getSkus().stream().map(sku -> {
    SkuEntity skuEntity = BaiduBeanUtil.copyProperties(sku,
    SkuEntity.class);
    skuEntity.setSpuId(spuEntity.getId());
    skuEntity.setCreateTime(date);
    skuEntity.setLastUpdateTime(date);
    return skuEntity;
    }).collect(Collectors.toList());
    //注意此处不能使用批量新增,因为库存数据也需要入库.....
    skuMapper.insertList(skuEntities);*/
spuDTO.getSkus().stream().forEach(skuDto -> {
SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDto,
SkuEntity.class);
skuEntity.setSpuId(spuEntity.getId());
skuEntity.setCreateTime(date);
skuEntity.setLastUpdateTime(date);
skuMapper.insertSelective(skuEntity);
StockEn7 tity stockEntity = new StockEntity();
stockEntity.setSkuId(skuEntity.getId());
stockEntity.setStock(skuDto.getStock());
stockMapper.insertSelective(stockEntity);
});
return this.setResultSuccess();
}
```

### 5.修改（回显数据）

#### 前台

![image-20210108200430978](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108200430978.png)

![image-20210108200438061](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108200438061.png)

![image-20210108200445923](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108200445923.png)

```
editItem(item) {
        //this.selectedGoods = item;

        // const names = item.categoryName.split("/");
        // this.selectedGoods.categories = [
        //   {id: item.cid1, name: names[0]},
        //   {id: item.cid2, name: names[1]},
        //   {id: item.cid3, name: names[2]}
        // ];
        // 查询商品详情
        //保证isEdit状态为true
        this.isEdit = true;
        this.show = true;

        //只监控一次oldGoods
        let obj = item;
        this.$http.get("/goods/getSpuDetailBySpuId",{
          params:{
            spuId:item.id
          }
        }).then(resp => {
          obj.categories = [];//解决监控到的值为undefined
          obj.spuDetail = resp.data.data;
          obj.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
          obj.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数

            // this.selectedGoods.spuDetail = resp.data.data;
            // this.selectedGoods.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
            // this.selectedGoods.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数
            //通过spuId查询skus
            this.$http.get('/goods/getSkusBySpuId',{
              params:{
                spuId:item.id
              }
            }).then(resp => {
              obj.skus = resp.data.data;
              this.selectedGoods = obj;
            }).catch(error => console.log(error));

        })
        
      },
```

GoodsForm.vue

```
oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

          // 先得到分类名称 bug!!!!
          window.setTimeout(() => {
            const names = val.categoryName.split("/");
            // 组织商品分类数据
            this.goods.categories = [
              { id: val.cid1, name: names[0] },
              { id: val.cid2, name: names[1] },
              { id: val.cid3, name: names[2] }
            ];
          },50)
          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        console.log(val)
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/getSpecParamInfo",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
```

#### 后台

mingrui-shop-service-api-xxx

GoodsService

```
@ApiOperation(value = "通过spuId查询spudetail信息")
@GetMapping(value = "/goods/getSpuDetailBySpuId")
Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId);

@ApiOperation(value = "通过spuId查询sku信息")
@GetMapping(value = "/goods/getSkusBySpuId")
Result<List<SkuDTO>> getSkusBySpuId(Integer spuId);
```

mingrui-shop-service-xxx

SkuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}
```

GoodsServiceImpl

```
@Override
public Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId) {
    SpuDetailEntity spuDetailEntity = spuDetailMapper.selectByPrimaryKey(spuId);
    return this.setResultSuccess(spuDetailEntity);
}

@Override
public Result<List<SkuDTO>> getSkusBySpuId(Integer spuId) {
    List<SkuDTO> list = skuMapper.getSkusAndStockBySpuId(spuId);
    return this.setResultSuccess(list);
}
```

### 6.修改（后台）

#### 前台

GoodsForm.vue

line:227

```
this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
```

#### 后台

mingrui-shop-service-api-xxx

GoodsService

```
@ApiOperation(value = "新增商品")
@PostMapping(value = "/goods/save")
Result<JSONObject> saveGoods(@Validated({MingruiOperation.Add.class}) @RequestBody SpuDTO spuDTO);
@ApiOperation(value = "修改商品")
@PutMapping(value = "/goods/save")
Result<JSONObject> editGoods(@Validated({MingruiOperation.Update.class}) @RequestBody SpuDTO spuDTO);
```

mingrui-shop-service-xxx

修改SkuMapper和StockMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity>, DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}
```

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}
```

GoodsServiceImpl

```
@Override
@Transactional
public Result<JSONObject> editGoods(SpuDTO spuDTO) {
    final Date date = new Date();
    //修改spu
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class);
    spuEntity.setLastUpdateTime(date);
    spuMapper.updateByPrimaryKeySelective(spuEntity);

    //修改spuDetail
    spuDetailMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(),SpuDetailEntity.class));

    //通过spuId查询sku信息
    this.deleteSkusAndStock(spuEntity.getId());

    this.saveSkusAndStockInfo(spuDTO,spuEntity.getId(),date);
    return this.setResultSuccess();
}

private void saveSkusAndStockInfo(SpuDTO spuDTO, Integer spuId, Date date) {
    List<SkuDTO> skus = spuDTO.getSkus();
    skus.stream().forEach(skuDTO -> {
        SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO,SkuEntity.class);
        skuEntity.setSpuId(spuId);
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });
}
```

### 7.删除

#### 前台

Goods.vue

```
deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/goods/delete?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
```

#### 后台

mingrui-shop-service-api-xxx

GoodsService

```
@ApiOperation(value = "删除商品")
@DeleteMapping(value = "/goods/delete")
Result<JSONObject> deleteGoods(Integer spuId);
```

mingrui-shop-service-xxx

GoodsServiceImpl

```
private void saveSkusAndStockInfo(SpuDTO spuDTO, Integer spuId, Date date) {
    List<SkuDTO> skus = spuDTO.getSkus();
    skus.stream().forEach(skuDTO -> {
        SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO,SkuEntity.class);
        skuEntity.setSpuId(spuId);
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });
}

@Override
@Transactional
public Result<JSONObject> deleteGoods(Integer spuId) {
    //删除spu
    spuMapper.deleteByPrimaryKey(spuId);
    //删除spuDetail
    spuDetailMapper.deleteByPrimaryKey(spuId);
    //删除sku 和 stock
    //通过spuId查询sku信息
    this.deleteSkusAndStock(spuId);
    return this.setResultSuccess();
}
```

### 8.上下架

#### 前台

Goods.vue

line:54

```
<v-btn icon small v-if="props.item.saleable" @click="down(props.item)">下架</v-btn>
          <v-btn icon v-else @click="down(props.item)">上架</v-btn>
```

line:146

```
down(spuList){
        this.$http({
          method:"put",
          url:"/goods/downOrUp",
          data:spuList
        })
        .then(resp => {
          //刷新页面
          this.getDataFromApi();
          this.$message.success(resp.data.message)
        }).catch(error => console.log(error))
      },
```

#### 后台

GoodsService

```
@ApiOperation(value = "上下架")
@PutMapping(value = "/goods/downOrUp")
Result<JSONObject> upOrDown(@RequestBody SpuDTO spuDTO);
```

GoodsServiceImpl

```
@Override
public Result<JSONObject> upOrDown(SpuDTO spuDTO) {
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class);
    if (ObjectUtil.isNotNull(spuEntity.getSaleable()) && spuEntity.getSaleable() != 2){
        if (spuEntity.getSaleable() == 1){
            spuEntity.setSaleable(0);
            spuMapper.updateByPrimaryKeySelective(spuEntity);
            return this.setResultSuccess("已下架");
        }else {
            spuEntity.setSaleable(1);
            spuMapper.updateByPrimaryKeySelective(spuEntity);
            return this.setResultSuccess("已上架");
        }
    }
    return this.setResultError("失败");
}
```

## 8.总前台

GoodsForm.vue

```
<template>
  <v-stepper v-model="step">
    <v-stepper-header>
      <v-stepper-step :complete="step > 1" step="1">基本信息1</v-stepper-step>
      <v-divider/>
      <v-stepper-step :complete="step > 2" step="2">商品描述2</v-stepper-step>
      <v-divider/>
      <v-stepper-step :complete="step > 3" step="3">规格参数3</v-stepper-step>
      <v-divider/>
      <v-stepper-step step="4">SKU属性</v-stepper-step>
    </v-stepper-header>
    <v-stepper-items>
      <!--1、基本信息-->
      <v-stepper-content step="1">
        <v-flex class="xs10 mx-auto">
          <v-form v-model="valid" ref="basic">
            <v-layout row>
              <v-flex xs5>
                <!--商品分类-->
                <v-cascader
                  url="/category/list"
                  required
                  showAllLevels
                  v-model="goods.categories"
                  label="请选择商品分类"/>
              </v-flex>
              <v-spacer/>
              <v-flex xs5>
                <!--品牌-->
                <v-select
                  :items="brandOptions"
                  item-text="name"
                  item-value="id"
                  label="所属品牌"
                  v-model="goods.brandId"
                  required
                  autocomplete
                  clearable
                  dense chips
                  :rules="[v => !!v || '品牌不能为空']"
                >
                  <template slot="selection" slot-scope="data">
                    <v-chip small>{{ data.item.name}}</v-chip>
                  </template>
                </v-select>
              </v-flex>
            </v-layout>
            <v-text-field label="商品标题" v-model="goods.title" :counter="200" required :rules="[v => !!v || '商品标题不能为空']" hide-details/>
            <v-text-field label="商品卖点" v-model="goods.subTitle" :counter="200" hide-details/>
            <v-text-field label="包装清单" v-model="goods.spuDetail.packingList" :counter="1000" multi-line :rows="3" hide-details/>
            <v-text-field label="售后服务" v-model="goods.spuDetail.afterService" :counter="1000" multi-line :rows="3" hide-details/>
          </v-form>
        </v-flex>
      </v-stepper-content>
      <!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
      </v-stepper-content>
      <!--3、规格参数-->
      <v-stepper-content step="3">
        <v-flex class="xs10 mx-auto px-3">
          <!--遍历整个规格参数-->
          <v-card class="my-2">
            <v-container grid-list-md fluid>
            <v-layout wrap row justify-space-between class="px-5">
              <v-flex xs12 sm5 v-for="param in specs" :key="param.name">
                <v-text-field :label="param.name" v-model="param.v" :suffix="param.unit || ''"
                 />
              </v-flex>
            </v-layout>
          </v-container>
          </v-card>
        </v-flex>
      </v-stepper-content>
      <!--4、SKU属性-->
      <v-stepper-content step="4">
        <v-flex class="mx-auto">
          <!--遍历特有规格参数-->
          <v-card flat v-for="spec in specialSpecs" :key="spec.name">
            <!--特有参数的标题-->
            <div class="subheading">{{spec.name}}:</div>
            <!--特有参数的待选项，需要判断是否有options，如果没有，展示文本框，让用户自己输入-->
            <v-card-text class="px-5">
              <div v-for="i in spec.options.length+1" :key="i" class="layout row px-5">
                <v-text-field :placeholder="'新的' + spec.name + ':'" class="flex xs10" auto-grow
                              v-model="spec.options[i-1]" v-bind:value="i" single-line hide-details/>

                <v-btn @click="spec.options.splice(i-1,1)" v-if="i <= spec.options.length" icon>
                  <i class="el-icon-delete"/>
                </v-btn>
              </div>
            </v-card-text>
          </v-card>
          <v-card class="elevation-0">
            <!--标题-->
            <div class="subheading py-3">SKU列表:</div>
            <v-divider/>
            <!--SKU表格，hide-actions因此分页等工具条-->
            <v-data-table :items="skus" :headers="headers" hide-actions item-key="indexes" class="elevation-0">
              <template slot="items" slot-scope="props">
                <tr @click="props.expanded = !props.expanded">
                  <!--价格和库存展示为文本框-->
                  <td v-for="(v,k) in props.item" :key="k" v-if="['price', 'stock'].includes(k)"
                      class="text-xs-center">
                    <v-text-field single-line v-model="props.item[k]" @click.stop=""/>
                  </td>
                  <!--enable展示为checkbox-->
                  <td class="text-xs-center" v-else-if="k === 'enable'">
                    <v-checkbox v-model="props.item[k]"/>
                  </td>
                  <!--indexes和images不展示，其它展示为普通文本-->
                  <td class="text-xs-center" v-else-if="k !== 'images' && k !== 'indexes'">{{v.v}}</td>
                </tr>
              </template>
              <!--点击表格后展开-->
              <template slot="expand" slot-scope="props">
                <v-card class="elevation-2 flex xs11 mx-auto my-2">
                  <!--图片上传组件-->
                  <v-upload v-model="props.item.images" url="/upload"/>
                </v-card>
              </template>
            </v-data-table>
          </v-card>
        </v-flex>
        <!--提交按钮-->
        <v-flex xs3 offset-xs9>
          <v-btn color="info" @click="submit">保存商品信息</v-btn>
        </v-flex>
      </v-stepper-content>
    </v-stepper-items>
  </v-stepper>
</template>

<script>
export default {
  name: "goods-form",
  props: {
    oldGoods: {
      type: Object
    },
    isEdit: {
      type: Boolean,
      default: false
    },
    step: {
      type: Number,
      default: 1
    }
  },
  data() {
    return {
      valid:false,
      goods: {
        categories: [], // 商品分类信息
        brandId: 0, // 品牌id信息
        title: "", // 标题
        subTitle: "", // 子标题
        spuDetail: {
          packingList: "", // 包装列表
          afterService: "", // 售后服务
          description: "" // 商品描述
        }
      },
      brandOptions: [], // 品牌列表
      specs: [], // 规格参数的模板
      specialSpecs: [] // 特有规格参数模板
    };
  },
  methods: {
    submit() {
      // 表单校验。
      if(!this.$refs.basic.validate){
        this.$message.error("请先完成表单内容！");
      }
      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中
      const {
        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],
        ...goodsParams
      } = this.goods;
      // 处理规格参数
      const specs = {};
      this.specs.forEach(({ id,v }) => {
        specs[id] = v;
      });
      // 处理特有规格参数模板
      const specTemplate = {};
      this.specialSpecs.forEach(({ id, options }) => {
        specTemplate[id] = options;
      });
      // 处理sku

      console.log(this.skus)
      const skus = this.skus
        .filter(s => s.enable)
        .map(({ price, stock, enable, images, indexes, ...rest }) => {
          // 标题，在spu的title基础上，拼接特有规格属性值
          const title = goodsParams.title + " " + Object.values(rest).map(v => v.v).join(" ");
          const obj = {};
          Object.values(rest).forEach(v => {
            obj[v.id] = v.v;
          });
          return {
            price: this.$format(price), // 价格需要格式化
            stock,
            indexes,
            enable,
            title, // 基本属性
            //images: images ? images.join(",") : '', // 图片
            images: images ? images.map(image => image.data).join(",") : '',
            ownSpec: JSON.stringify(obj) // 特有规格参数
          };
        });
      Object.assign(goodsParams, {
        cid1,
        cid2,
        cid3, // 商品分类
        skus // sku列表
      });
      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);
      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);

      //console.log(JSON.stringify(goodsParams))
      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
        .then(() => {
          // 成功，关闭窗口
          this.$emit("closeForm");
          // 提示成功
          this.$message.success("保存成功了");
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    }
  },
  watch: {
    oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

          // 先得到分类名称 bug!!!!
          window.setTimeout(() => {
            const names = val.categoryName.split("/");
            // 组织商品分类数据
            this.goods.categories = [
              { id: val.cid1, name: names[0] },
              { id: val.cid2, name: names[1] },
              { id: val.cid3, name: names[2] }
            ];
          },50)
          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        console.log(val)
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/getSpecParamInfo",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
  computed: {
    skus() {
      // 过滤掉用户没有填写数据的规格参数
      const arr = this.specialSpecs.filter(s => s.options.length > 0);
      // 通过reduce进行累加笛卡尔积
      return arr.reduce(
        (last, spec, index) => {
          const result = [];
          last.forEach(o => {
            spec.options.forEach((option, i) => {
              const obj = JSON.parse(JSON.stringify(o));
              obj[spec.name] = {v:option, id:spec.id};
              obj.indexes = (obj.indexes || '') + '_' +  i
              if (index === arr.length - 1) {
                obj.indexes = obj.indexes.substring(1);
                // 如果发现是最后一组，则添加价格、库存等字段
                Object.assign(obj, {
                  price: 0,
                  stock: 0,
                  enable: false,
                  images: []
                });
                if (this.isEdit) {
                  // 如果是编辑，则回填sku信息
                  const sku = this.goods.skus.get(obj.indexes);
                  if (sku != null) {
                    const { price, stock, enable, images } = sku;
                    Object.assign(obj, {
                      price: this.$format(price),
                      stock,
                      enable,
                      images: images ? images.split(",") : [],
                    });
                  }
                }
              }
              result.push(obj);
            });
          });
          return result;
        },
        [{}]
      );
    },
    headers() {
      if (this.skus.length <= 0) {
        return [];
      }
      const headers = [];
      Object.keys(this.skus[0]).forEach(k => {
        let value = k;
        if (k === "price") {
          // enable，表头要翻译成“价格”
          k = "价格";
        } else if (k === "stock") {
          // enable，表头要翻译成“库存”
          k = "库存";
        } else if (k === "enable") {
          // enable，表头要翻译成“是否启用”
          k = "是否启用";
        } else if (k === "images" || k === 'indexes') {
          // 图片和索引不在表格中展示
          return;
        }
        headers.push({
          text: k,
          align: "center",
          sortable: false,
          value
        });
      });
      return headers;
    }
  }
};
</script>

<style scoped>
</style>

```

Goods.vue

```
<template>
  <v-card>
    <v-toolbar class="elevation-0">
      <v-btn @click="addItem" color="primary">新增商品</v-btn>
      <v-spacer/>
      <v-flex xs3>
        状态：
        <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>
      </v-flex>
      <v-flex xs3>
        <v-text-field
          append-icon="search"
          label="搜索"
          single-line
          hide-details
          v-model="search.key"
        />
      </v-flex>
    </v-toolbar>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.title }}</td>
        <!-- <td class="text-xs-center">{{ props.item.cid1}}/{{ props.item.cid2}}/{{ props.item.cid3}}</td>
        <td class="text-xs-center">{{ props.item.brandId }}</td> -->

        <td class="text-xs-center">{{ props.item.categoryName}}</td>
        <td class="text-xs-center">{{ props.item.brandName }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon small @click="editItem(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon small @click="deleteItem(props.item.id)">
            <i class="el-icon-delete"/>
          </v-btn>
          <v-btn icon small v-if="props.item.saleable" @click="down(props.item)">下架</v-btn>
          <v-btn icon v-else @click="down(props.item)">上架</v-btn>
        </td>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-if="show" v-model="show" max-width="900" scrollable persistent>
      <v-card>
        <v-toolbar dense dark color="primary">
          <v-toolbar-title>{{isEdit ? '修改商品' : '新增商品'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="closeForm">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text style="height: 600px;">
          <!-- 表单 -->
          <goods-form :oldGoods="selectedGoods" :isEdit="isEdit" :step="step" ref="goodsForm" @closeForm="closeForm"/>
        </v-card-text>
        <v-card-actions>
          <v-layout row justify-center>
            <v-flex xs2>
              <v-btn :disabled="step === 1" @click="lastStep">上一步</v-btn>
            </v-flex>
            <v-flex xs2>
              <v-btn :disabled="step === 4" color="primary" @click="nextStep">下一步</v-btn>
            </v-flex>
          </v-layout>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-card>
</template>

<script>
  import GoodsForm from './GoodsForm'
 // import {goodsData} from "../../mockDB";

  export default {
    name: "item",
    components: {
      GoodsForm
    },
    data() {
      return {
        search: {
          key: '',
          saleable: true,
        },// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '标题', align: 'center', sortable: false, value: 'name'},
          {text: '商品分类', align: 'center', sortable: false, value: 'image'},
          {text: '品牌', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        selectedGoods: null, // 选中的商品信息
        isEdit: false, // 判断是编辑还是新增
        step: 1// 表单中的导航条
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      down(spuList){
        this.$http({
          method:"put",
          url:"/goods/downOrUp",
          data:spuList
        })
        .then(resp => {
          //刷新页面
          this.getDataFromApi();
          this.$message.success(resp.data.message)
        }).catch(error => console.log(error))
      },
      closeForm() {
        this.isEdit = false;
        this.show = false;
        this.step = 1;
        this.selectedGoods = null;
        this.getDataFromApi();
      },
      lastStep() {
        if (this.step === 1) {
          return;
        }
        this.step--;
      },
      nextStep() {
        if (this.step === 4) {
          return;
        }
        if (this.$refs.goodsForm.$refs.basic.validate()) {
          this.step++;
        }
      },
      addItem() {
        this.selectedGoods = null;
        this.isEdit = false;
        this.show = true;
      },
      editItem(item) {
        //this.selectedGoods = item;

        // const names = item.categoryName.split("/");
        // this.selectedGoods.categories = [
        //   {id: item.cid1, name: names[0]},
        //   {id: item.cid2, name: names[1]},
        //   {id: item.cid3, name: names[2]}
        // ];
        // 查询商品详情
        //保证isEdit状态为true
        this.isEdit = true;
        this.show = true;

        //只监控一次oldGoods
        let obj = item;
        this.$http.get("/goods/getSpuDetailBySpuId",{
          params:{
            spuId:item.id
          }
        }).then(resp => {
          obj.categories = [];//解决监控到的值为undefined
          obj.spuDetail = resp.data.data;
          obj.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
          obj.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数

            // this.selectedGoods.spuDetail = resp.data.data;
            // this.selectedGoods.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
            // this.selectedGoods.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数
            //通过spuId查询skus
            this.$http.get('/goods/getSkusBySpuId',{
              params:{
                spuId:item.id
              }
            }).then(resp => {
              obj.skus = resp.data.data;
              this.selectedGoods = obj;
            }).catch(error => console.log(error));

        })
        
      },
      deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/goods/delete?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
      getDataFromApi() {
        this.loading = true;
        this.$http.get('/goods/getSpuInfo',{
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            saleable:this.search.saleable,
            title: this.search.key
          },
        }).then(resp => {
          //this.items = resp.data.data.list;
          this.items = resp.data.data;
          //this.totalItems = parseInt(resp.data.message);
          this.totalItems = resp.data.message - 0;
          this.loading = false;
        }).catch(error => console.log(error))
        
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
    }
  }
</script>

<style scoped>
  label {
    font-size: 14px;
  }
</style>

```

